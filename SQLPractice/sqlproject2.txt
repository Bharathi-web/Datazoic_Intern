use SQLTraining;
--------------------------------------------CREATING SCHEMA----------------------------------------------

IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = N'FLOG')
BEGIN
EXEC('CREATE SCHEMA FLOG AUTHORIZATION SQLTraining');
END
GO

---------------------------------------------CREATING TABLES-----------------------------------------------

------------MS_ROLES TABLE----------------------
IF NOT EXISTS(SELECT * FROM SYS.TABLES WHERE NAME='ROLES' AND SCHEMA_ID=SCHEMA_ID('FLOG'))
Begin
CREATE TABLE FLOG.MS_ROLES (
role_id INT IDENTITY(1,1) PRIMARY KEY,
role_name VARCHAR(50) NOT NULL UNIQUE,
active_flag BIT DEFAULT 1,
created_at DATETIME DEFAULT GETDATE(),
modified_at DATETIME NULL
);
END
go
 
 SELECT role_id, role_name,active_flag,created_at,modified_at FROM FLOG.MS_ROLES WITH (NOLOCK);
 go


 ------------------MS_USERS TABLE-----------

IF NOT EXISTS (SELECT * FROM sys.tables WHERE NAME = 'USERS' AND schema_id = SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.MS_USERS (
user_id INT IDENTITY(1,1) PRIMARY KEY,
role_id INT NOT NULL, -- JOIN WITH ROLES
user_name VARCHAR(100) NOT NULL,
email VARCHAR(100) NOT NULL UNIQUE,
password VARCHAR(200) NOT NULL,
active_flag BIT DEFAULT 1,
created_at DATETIME DEFAULT GETDATE(),
modified_at DATETIME NULL
);
END
GO

SELECT user_id,role_id,user_name,email,password,active_flag,created_at,modified_at from FLOG.MS_USERS WITH (NOLOCK);
go


----------------------DD_DRIVERS TABLE-------------

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name='DRIVERS' AND schema_id=SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.DD_DRIVERS (
driver_id INT IDENTITY(1,1) PRIMARY KEY,
user_id INT NOT NULL, -- JOIN WITH USERS
license_number VARCHAR(50) NOT NULL UNIQUE,
phone VARCHAR(15),
active_flag BIT DEFAULT 1,
created_at DATETIME DEFAULT GETDATE(),
modified_at DATETIME NULL
    );
END
GO

SELECT driver_id,user_id,license_number,phone,active_flag,created_at,modified_at FROM FLOG.DD_DRIVERS WITH (NOLOCK);
go


------------------------DD_VEHICLES TABLE-------------
 
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name='VEHICLES' AND schema_id=SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.DD_VEHICLES (
vehicle_id INT IDENTITY(1,1) PRIMARY KEY,
vehicle_number VARCHAR(50) NOT NULL UNIQUE,
type VARCHAR(50) NOT NULL,
capacity INT,
active_flag BIT DEFAULT 1,
created_at DATETIME DEFAULT GETDATE(),
modified_at DATETIME NULL
);
END
GO


	SELECT vehicle_id,vehicle_number,type,capacity,active_flag,created_at,modified_at FROM FLOG.DD_VEHICLES WITH (NOLOCK);
go


-------------------------DD_CUSTOMERS TABLE--------------------
 
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name='CUSTOMERS' AND schema_id=SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.DD_CUSTOMERS (
customer_id INT IDENTITY(1,1) PRIMARY KEY,
user_id INT NOT NULL, -- JOIN WITH USERS
phone VARCHAR(15),
address VARCHAR(255),
active_flag BIT DEFAULT 1,
created_at DATETIME DEFAULT GETDATE(),
modified_at DATETIME NULL
);
END
GO


SELECT customer_id,user_id,phone,address,active_flag,created_at,modified_at FROM FLOG.DD_CUSTOMERS WITH(NOLOCK);
go


-------------------------DD_TRIPS TABLE------------------------
 
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name='TRIPS' AND schema_id=SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.DD_TRIPS (
trip_id INT IDENTITY(1,1) PRIMARY KEY,
customer_id INT NOT NULL, -- JOIN WITH CUSTOMERS
driver_id INT NOT NULL,   -- JOIN WITH DRIVERS
vehicle_id INT NOT NULL,  -- JOIN WITH VEHICLES
start_time DATETIME,
end_time DATETIME,
distance_km DECIMAL(10,2),
status VARCHAR(50) DEFAULT 'Scheduled',
active_flag BIT DEFAULT 1,
created_at DATETIME DEFAULT GETDATE(),
modified_at DATETIME NULL
);
END
GO

ALTER TABLE FLOG.DD_TRIPS
ADD booking_id INT ;
SELECT trip_id,customer_id,driver_id,vehicle_id,start_time,end_time,distance_km,status,active_flag,created_at,modified_at FROM FLOG.DD_TRIPS WITH (NOLOCK);

ALTER TABLE FLOG.DD_TRIPS
DROP COLUMN BOOKING_ID;


---------------------------DD_CHANGE_LOGS TABLE----------------------

 
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name='CHANGE_LOGS' AND schema_id=SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.MS_CHANGE_LOGS (
log_id INT IDENTITY(1,1) PRIMARY KEY,
table_name VARCHAR(50),
record_id INT,
action_type VARCHAR(50), -- INSERT/UPDATE/DELETE
modified_by INT,         -- USER_ID FROM USERS
modified_at DATETIME DEFAULT GETDATE()
);
END
GO

SELECT log_id,table_name,record_id,action_type,modified_by,modified_at FROM FLOG.MS_CHANGE_LOGS WITH (NOLOCK);
go


-----------------------------DD_BOOKING TABLE---------------------------------

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name='BOOKINGS' AND schema_id=SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.DD_BOOKINGS (
    booking_id INT IDENTITY(1,1) PRIMARY KEY,
    customer_id INT NOT NULL,
	user_id INT NOT NULL, --JOINS
    pickup_location VARCHAR(200) NOT NULL,
    drop_location VARCHAR(200) NOT NULL,
    status VARCHAR(20) DEFAULT 'Pending',
    created_at DATETIME DEFAULT GETDATE(),
    updated_at DATETIME NULL,
);
END

SELECT booking_id,customer_id,user_id,pickup_location,drop_location,status,created_at,updated_at FROM FLOG.DD_BOOKINGS WITH (NOLOCK);


-----------------------------------DD_PAYMENTS--------------------------------------

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name='PAYMENTS' AND schema_id=SCHEMA_ID('FLOG'))
BEGIN
CREATE TABLE FLOG.DD_PAYMENTS (
payment_id INT IDENTITY(1,1) PRIMARY KEY,
trip_id INT, --JOIN WITH TRIPS 
amount_mode VARCHAR(50) CHECK (AMOUNT_MODE IN ('ONLINE','BYCASH')),
status VARCHAR(20) CHECK (STATUS IN ('PAID','UNPAID'))
);
END
GO

ALTER TABLE FLOG.DD_PAYMENTS
ADD amount INT NOT NULL;

alter table flog.dd_payments
ADD CONSTRAINT CH_PAYMENTS_MODE CHECK (PAYMENT_MODE IN ('ONLINE','BYCASH'));

SELECT * FROM FLOG.DD_PAYMENTS;

ALTER TABLE FLOG.DD_PAYMENTS
ADD created_at DATETIME NOT NULL CONSTRAINT DF_PAYMENTS_CREATEDAT DEFAULT GETDATE();

ALTER TABLE FLOG.DD_PAYMENTS
ADD modified_at DATETIME NULL;

SELECT payment_id,trip_id,status,created_at,modified_at,amount,payment_mode FROM FLOG.DD_PAYMENTS WITH (NOLOCK);
go


-------------------------------------------------------INSERT INTO TABLE------------------------------------------

--INSERT INTO FLOG.MS_ROLES
INSERT INTO FLOG.MS_ROLES (Role_name) VALUES 
('SuperAdmin'),
('SupportAdmin'),
('Driver'),
('Customer');

--INSERT INTO FLOG.MS_USERS
INSERT INTO FLOG.MS_USERS (role_id,user_name,email,password) VALUES
(1,'MainAdmin','MainAdmin@fleet.com','Admin@123'),
(2,'SupportAdmin','SupportAdmin@fleet.com','SpAdmin@123'),
(3,'Driver1','Driver1@fleet.com','driver1@123'),
(4,'Custom1','Customer1@123.com','customer@123');

--INSERT INTO FLOG.DD_DRIVERS
INSERT INTO FLOG.DD_DRIVERS (user_id,license_number,phone) VALUES
(3,'TN99-3364','8438933808');


--INSERT INTO FLOG.DD_CUSTOMERS
INSERT INTO FLOG.DD_CUSTOMERS (user_id,phone,address) VALUES
(4,'7568954369','123 ST,chennai');


--INSERT INTO FLOG.DD_VEHICLES
INSERT INTO FLOG.DD_VEHICLES (vehicle_number,type,capacity) VALUES 
('TN01ABC123','LORRY',10000),
('TN02ABC456','VAN',2000),
('TNO3ABC789','BIKE',100);


--INSERT INTO FLOG.DD_BOOKINGS
INSERT INTO FLOG.DD_BOOKINGS (customer_id,user_id,pickup_location,drop_location,status) VALUES
(1,1,'Chennai','Vellore','confirmed');


--INSERT INTO FLOG.DD_TRIPS
INSERT INTO FLOG.DD_TRIPS (customer_id,driver_id,vehicle_id,start_time,status) VALUES
(1,1,1, GETDATE(),'scheduled');


--INSERT INTO FLOG.DD_PAYMENTS
INSERT INTO FLOG.DD_PAYMENTS (trip_id,status,amount,payment_mode) VALUES
(1,'paid',2500,'Online');


--INSERT INTO FLOG.MS_CHANGE_LOGS
INSERT INTO FLOG.MS_CHANGE_LOGS (TABLE_NAME,RECORD_ID,ACTION_TYPE,MODIFIED_BY) VALUES
('USERS',3,'INSERT',1),
('DRIVERS',1,'INSERT',1),
('CUSTOMERS',1,'INSERT',1);

go


------------------------------------------------CONDITIONS-----------------------------------------------------------------------------------------
GO

--CHECK LOGS(WHO MODIFIED)
SELECT log_id, table_name, action_type, modified_by, modified_at FROM FLOG.MS_CHANGE_LOGS ORDER BY MODIFIED_AT DESC;


---SELECT ALL USERS WITH ROLES
SELECT u.user_id,u.user_name,u.email,r.role_name,u.active_flag FROM FLOG.MS_USERS u JOIN FLOG.MS_ROLES r ON u.role_id= r.role_id;


--SELECT TRIPS WITH CUSTOMER AND DRIVER DETAILS
SELECT t.trip_id, c.customer_id, u.user_name AS customer_name,
d.driver_id, du.user_name AS driver_name,v.vehicle_number, t.start_time, t.end_time, t.distance_km, t.status
FROM FLOG.DD_TRIPS t
JOIN FLOG.DD_CUSTOMERS c ON t.customer_id = c.customer_id
JOIN FLOG.MS_USERS u ON c.user_id = u.user_id
JOIN FLOG.DD_DRIVERS d ON t.driver_id = d.driver_id
JOIN FLOG.MS_USERS du ON d.user_id = du.user_id
JOIN FLOG.DD_VEHICLES v ON t.vehicle_id = v.vehicle_id;


-- SEARCH ALL ACTIVE DRIVERS
SELECT u.user_id, u.user_name,r.role_name FROM FLOG.MS_USERS u JOIN FLOG.MS_ROLES r ON u.role_id=r.role_id WHERE r.role_name='driver' AND u.active_flag=1;


---------------------------------------------------------VALIDATION ----------------------------------------------------------------------------------------

------------------------CREATING STORE PROCEDURE FOR SP_REGISTER_USERS------------


GO
 
CREATE PROCEDURE SP_REGISTER_USER
@role_id INT,
@user_name VARCHAR(100),
@email VARCHAR(100),
@password VARCHAR(200),
@created_by INT  -- ADDED BY WHOME (SUPERADMIN OR SELF)
AS
BEGIN
SET NOCOUNT ON;
 
-- 1. Check duplicate email
IF EXISTS (SELECT 1 FROM FLOG.MS_USERS WHERE email = @email AND active_flag=1)
BEGIN
PRINT 'USER ALREADY EXISTS';
RETURN;
END
 
-- 2. Insert new user
INSERT INTO FLOG.MS_USERS (role_id, user_name, email, password, active_flag, created_at) VALUES (@role_id, @user_name, @email, @password, 1, GETDATE());
 
DECLARE @new_user_id INT = SCOPE_IDENTITY();
 
-- 3. Insert into Change Logs
INSERT INTO FLOG.MS_CHANGE_LOGS (table_name, record_id, action_type, modified_by, modified_at) VALUES ('USERS', @new_user_id, 'INSERT', @created_by, GETDATE());
 
PRINT 'User registered successfully with ID = ' + CAST(@new_user_id AS VARCHAR);
END;
GO

EXEC SP_REGISTER_USER
@role_id=5,
@user_name='priya',
@email='priya@fleet.com',
@password='Priya123',
@created_by=1;


------------------------CREATING STORE PROCEDURE FOR SP_LOGIN_USER------------

GO

CREATE PROCEDURE SP_LOGIN_USER
@email NVARCHAR(100),
@password NVARCHAR(100)
AS
BEGIN
SET NOCOUNT ON;
 
IF EXISTS (SELECT 1 FROM FLOG.MS_USERS WHERE email = @email AND password = @password AND active_flag = 1)
BEGIN
SELECT user_id, user_name, email, role_id FROM FLOG.MS_USERS WHERE email = @email AND password = @password AND active_flag = 1;
END
ELSE
BEGIN
RAISERROR('Invalid login credentials or inactive user.', 16, 1);
END
END;

EXEC SP_LOGIN_USER
@email='priya@fleet.com',
@password='Priy3';
 

 ------------------------CREATING STORE PROCEDURE FOR SP_CREATE_BOOKING------------

GO

CREATE OR ALTER PROCEDURE SP_CREATE_BOOKING
@customer_id INT,
@pickup_location VARCHAR(200),
@drop_location VARCHAR(200),
@user_id INT
AS
BEGIN
SET NOCOUNT ON;
 
DECLARE @new_booking_id INT;
 
INSERT INTO FLOG.DD_BOOKINGS (customer_id, pickup_location, drop_location, user_id, status) VALUES (@customer_id, @pickup_location, @drop_location, @user_id,'Pending');

 
SET @new_booking_id = SCOPE_IDENTITY();
 
PRINT 'Booking created successfully with ID ' + CAST(@new_booking_id AS VARCHAR);
END;
 
 
EXEC SP_CREATE_BOOKING
@customer_id = 4,
@pickup_location = 'Kanchipuram Bus Stand',
@drop_location = 'Chennai CMBT',
@user_id=1;

 ------------------------CREATING STORE PROCEDURE FOR SP_CREATE_BOOKING------------

GO

 CREATE OR ALTER PROCEDURE SP_CONFIRM_BOOKING
    @booking_id INT,
    @driver_id INT,
    @vehicle_id INT
    
AS
BEGIN
    SET NOCOUNT ON;
 
    -- Step 1: Update the booking status
    UPDATE FLOG.DD_BOOKINGS SET status = 'Confirmed', updated_at = GETDATE() WHERE booking_id = @booking_id;
 
    -- Step 2: Insert booking details into TRIPS
    INSERT INTO FLOG.DD_TRIPS(customer_id,driver_id,vehicle_id,start_time,status,active_flag,created_at,booking_id)
    SELECT b.customer_id,@driver_id,@vehicle_id,GETDATE(),'Confirmed',1,GETDATE(),b.booking_id
    FROM FLOG.DD_BOOKINGS b
    WHERE b.booking_id = @booking_id
      AND b.status = 'Confirmed';  -- ensure only confirmed moves to TRIPS
 
    PRINT 'Booking confirmed and Trip created!';
END;

exec SP_CONFIRM_BOOKING
 @booking_id=3,
    @driver_id=1,
    @vehicle_id=1;

	select * from FLOG.DD_TRIPS;


 ------------------------CREATING STORE PROCEDURE FOR SP_MAKE_PAYEMENT------------
 
GO

 CREATE PROCEDURE SP_MAKE_PAYMENT
 @trip_id INT,
 @payment_mode NVARCHAR(50),
 @amount DECIMAL(10,2)
 AS
 BEGIN
 SET NOCOUNT ON;

 INSERT INTO FLOG.DD_PAYMENTS(trip_id,amount,status,payment_mode,created_at) VALUES  (@trip_id,@amount,'paid',@payment_mode,getdate());
 PRINT 'PAYMENT SUCCESSFULL';
 END;
 
 EXEC SP_MAKE_PAYMENT
 @trip_id=1,
 @amount=100,
 @payment_mode='BYCASH';



 ------------------------CREATING STORE PROCEDURE FOR SP_COMPLETE_TRIP------------
 
GO


 CREATE OR ALTER PROCEDURE SP_COMPLETE_TRIP
    @trip_id INT,
    @modified_by INT,
	@distance DECIMAL(10,2)
AS
BEGIN
    SET NOCOUNT ON;
 
    -- Step 1: Update the trip record with end_time
    UPDATE FLOG.DD_TRIPS SET end_time = GETDATE(), status = 'Completed', modified_at = GETDATE(),distance_km=@distance WHERE trip_id = @trip_id
    AND active_flag = 1 AND status = 'Confirmed'; 
 
    -- Step 2: Insert into change logs for audit
    INSERT INTO FLOG.MS_CHANGE_LOGS ( table_name, record_id, action_type, modified_by, modified_at) VALUES 
	('TRIPS', @trip_id, 'UPDATE', @modified_by, GETDATE());
 
    PRINT 'Trip completed successfully!';
END;

EXEC SP_COMPLETE_TRIP
 @trip_id=2,
 @modified_by =1,
 @distance=10.5;
 SELECT * FROM FLOG.DD_TRIPS;

 ------------------------CREATING STORE PROCEDURE FOR SP_LOG_CHANGES------------

GO

CREATE PROCEDURE SP_LOG_CHANGES
@table_name NVARCHAR(100),
@record_id INT,
@action_type NVARCHAR(100),
@modified_by INT

AS
BEGIN
SET NOCOUNT ON;
INSERT INTO FLOG.MS_CHANGE_LOGS (table_name, record_id, action_type, modified_by, modified_at) VALUES (@table_name,@record_id,@action_type, @modified_by, GETDATE());
END;

EXEC SP_LOG_CHANGES
@table_name='BOOKINGS',
@record_id=8,
@action_type='INSERT',
@modified_by=1;

SELECT * FROM FLOG.MS_CHANGE_LOGS;


 ------------------------CREATING STORE PROCEDURE FOR SP_DELETE_USER------------

GO

CREATE OR ALTER PROCEDURE SP_DELETE_USER
@user_id INT,
@modified_by INT
AS
BEGIN
SET NOCOUNT ON;
 
    -- Step 1: Update user status to inactive
    UPDATE FLOG.MS_USERS SET active_flag = 0, modified_at = GETDATE() WHERE user_id = @user_id AND active_flag = 1;
 
    -- Step 2: Log this change
    INSERT INTO FLOG.MS_CHANGE_LOGS ( table_name, record_id, action_type, modified_by, modified_at)
    VALUES ('USERS', @user_id, 'DELETE', @modified_by, GETDATE());
 
    PRINT 'User deactivated successfully!';
END;

EXEC SP_DELETE_USER
@user_id=5,
@modified_by=1;